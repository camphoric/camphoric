import{R as h,_ as N,u as C,a as D,c as F,b,j as o,d as P,e as T,S as w,s as S,f as k,g as L,h as B}from"./index-942bd52f.js";import{u as I,a as J,P as V,d as _}from"./PageWrapper-99381d86.js";import{f as z,E as A,J as W,T as G,c as H}from"./JsonSchemaForm-d78752fd.js";var M=["bsPrefix","variant","animation","size","children","as","className"],$=h.forwardRef(function(t,e){var a=t.bsPrefix,r=t.variant,s=t.animation,n=t.size,u=t.children,g=t.as,c=g===void 0?"div":g,y=t.className,x=N(t,M);a=C(a,"spinner");var f=a+"-"+s;return h.createElement(c,D({ref:e},x,{className:F(y,f,n&&f+"-"+n,r&&"text-"+r)}),u)});$.displayName="Spinner";const O=$,Q=t=>{var r;const e=(r=t.property)==null?void 0:r.replace(/\[[0-9]*\]/g,"").split(".");return e?`#/properties${e.join("/")}`:""},U=t=>{var s;const e=(s=t.property)==null?void 0:s.replace(/\[[0-9]*\]/g,"").split(".");if(!e)return"";const a=e.findIndex(n=>n==="campers")+1;return`#/definitions/camper/properties/${e.slice(a).join("/")}`},q=t=>{var s;const e=(s=t.property)==null?void 0:s.replace(/\[[0-9]*\]/g,"").split(".");if(!e)return"";const a=e.findIndex(n=>n==="payment")+1;return`#/properties/payment/properties/${e.slice(a).join("/properties/")}`},K=t=>{var r;const e=(r=t.property)==null?void 0:r.replace(/\[[0-9]*\]/g,"").split(".");return e?`#/definitions/address/properties/${e.pop()}`:""},X=(t,e)=>[q(t),U(t),K(t),Q(t)].map(r=>{try{return z(r,e)}catch{}}).find(Boolean)||{},j=t=>{var a;const e=(a=t.property)==null?void 0:a.match(/campers\[([0-9]*)\]/);return!e||!e[1]?null:Number(e[1])+1},Y=(t,e,a)=>{const r=j(t);return{...t,message:"Lodging selection is incomplete",stack:`Camper ${r}: Lodging selection is incomplete`}},Z=(t,e,a)=>{var n;if((n=t.property)!=null&&n.includes(".lodging."))return Y(t);const r=j(t);let s=t.stack;return e!=null&&e.title&&(s=`Camper ${r}: ${e==null?void 0:e.title} ${t.message}`),{...t,message:`${(e==null?void 0:e.title)||"this"} ${t.message}`,stack:s}};let R;R=t=>e=>e.map(a=>{var s;const r=X(a,t);return(s=a.property)!=null&&s.startsWith(".campers[")?Z(a,r):a.name==="pattern"&&a.property===".payer_number"?{...a,message:"Please enter a valid phone number"}:r.title?{...a,message:`${r.title} ${a.message}`,stack:`${r.title} ${a.message}`}:a});const tt=R;function et(){const t=b();return o.jsxs("div",{className:"PriceTicker",children:[!!t.updating&&o.jsx(O,{style:{position:"absolute",color:"rgba(0, 0, 0, 0.4)"},animation:"border",role:"status"}),o.jsxs("div",{children:["Total: $",(t.totals.total||0).toFixed(2)]})]})}function nt(){const[t,e]=h.useState(!1),a=b(),r=P.useGetRegistrationQuery(),[s]=P.useCreateRegistrationMutation(),n=T(),u=I(),g=J();if(h.useEffect(()=>{try{u.rehydrateFormData()}catch(i){i instanceof Error&&i.message==="no local storage data"||console.error(i)}},[u]),r.isFetching||r.isLoading||!r.data||!u.rehydrated)return o.jsx(w,{});const c=r.data,y=tt(c.dataSchema),x=i=>{e(!0),window.scrollTo(0,0),i.forEach(p=>{var l;if(p.property.includes("phone")){let d=0,m=p.property.match(/.campers\[(\d+)\]/);if(m&&m[1]!==void 0)d=m[1];else return;let v=`root_campers_${d}`;if(m=p.property.match(/\.([^.]+)$/),m&&m[1]!==void 0)v=`root_campers_${d}_${m[1]}`;else return;(l=document.getElementById(v))==null||l.focus()}})},f=({formData:i,...p})=>{n(S(!0)),n(k(i)),n(L(H(c,i))),n(S(!1)),u.saveFormData(i)},E=async()=>{const{invitation:i}=c;try{const p={formData:a.registration,pricingResults:a.totals,...!!i&&{invitation:i}},l=await s(p);if(_("submitRegistration result",l),"error"in l)throw new Error(`error fetching data: ${JSON.stringify(l)}`);const{data:d}=l;await n(B(d)),g("/payment")}catch(p){console.error("submissionError",p)}};return o.jsx(V,{children:o.jsxs(A,{section:"RegistrationStep",children:[o.jsx(W,{schema:c.dataSchema,uiSchema:c.uiSchema,onChange:f,onSubmit:E,onError:x,formData:a.registration,transformErrors:y,templateData:{...c.templateVars||{},pricing:c.pricing,formData:a.registration,totals:a.totals},noHtml5Validate:!0,liveValidate:t,children:o.jsxs("div",{children:[o.jsx(G,{markdown:c.preSubmitTemplate}),o.jsx("button",{type:"submit",className:"btn btn-info",children:"Continue to payment"})]})}),o.jsx(et,{})]})})}export{nt as default};
