import{R as f,_ as N,u as C,a as D,c as T,b as P,j as n,d as S,e as w,S as k,s as b,f as L,g as _,h as J}from"./index-5013a17e.js";import{f as A,m as j,E as B,J as I,T as V,c as z,d as W}from"./JsonSchemaForm-e77ab531.js";import{u as H,a as G,P as M}from"./PageWrapper-d7601acd.js";var O=["bsPrefix","variant","animation","size","children","as","className"],$=f.forwardRef(function(t,e){var a=t.bsPrefix,r=t.variant,s=t.animation,i=t.size,d=t.children,g=t.as,o=g===void 0?"div":g,y=t.className,x=N(t,O);a=C(a,"spinner");var h=a+"-"+s;return f.createElement(o,D({ref:e},x,{className:T(y,h,i&&h+"-"+i,r&&"text-"+r)}),d)});$.displayName="Spinner";const Q=$,U=t=>{var r;const e=(r=t.property)==null?void 0:r.replace(/\[[0-9]*\]/g,"").split(".");return e?`#/properties${e.join("/")}`:""},q=t=>{var s;const e=(s=t.property)==null?void 0:s.replace(/\[[0-9]*\]/g,"").split(".");if(!e)return"";const a=e.findIndex(i=>i==="campers")+1;return`#/definitions/camper/properties/${e.slice(a).join("/")}`},K=t=>{var s;const e=(s=t.property)==null?void 0:s.replace(/\[[0-9]*\]/g,"").split(".");if(!e)return"";const a=e.findIndex(i=>i==="payment")+1;return`#/properties/payment/properties/${e.slice(a).join("/properties/")}`},X=t=>{var r;const e=(r=t.property)==null?void 0:r.replace(/\[[0-9]*\]/g,"").split(".");return e?`#/definitions/address/properties/${e.pop()}`:""},Y=(t,e)=>[K(t),q(t),X(t),U(t)].map(r=>{try{return A(r,e)}catch{}}).find(Boolean)||{},R=t=>{var a;const e=(a=t.property)==null?void 0:a.match(/campers\[([0-9]*)\]/);return!e||!e[1]?null:Number(e[1])+1},Z=(t,e,a)=>{const r=R(t);return{...t,message:"Lodging selection is incomplete",stack:`Camper ${r}: Lodging selection is incomplete`}},tt=(t,e,a)=>{var i;if((i=t.property)!=null&&i.includes(".lodging."))return Z(t);const r=R(t);let s=t.stack;return e!=null&&e.title&&(s=`Camper ${r}: ${e==null?void 0:e.title} ${t.message}`),{...t,message:`${(e==null?void 0:e.title)||"this"} ${t.message}`,stack:s}};let E;E=t=>e=>e.map(a=>{var s;const r=Y(a,t);return(s=a.property)!=null&&s.startsWith(".campers[")?tt(a,r):a.name==="pattern"&&a.property===".payer_number"?{...a,message:"Please enter a valid phone number"}:r.title?{...a,message:`${r.title} ${a.message}`,stack:`${r.title} ${a.message}`}:a});const et=E;function at(){const t=P();return n.jsxs("div",{className:"PriceTicker",children:[!!t.updating&&n.jsx(Q,{style:{position:"absolute",color:"rgba(0, 0, 0, 0.4)"},animation:"border",role:"status"}),n.jsxs("div",{children:["Total: ",j(t.totals.total)]})]})}function it(){const[t,e]=f.useState(!1),a=P(),r=S.useGetRegistrationQuery(),[s]=S.useCreateRegistrationMutation(),i=w(),d=H(),g=G();if(f.useEffect(()=>{try{d.rehydrateFormData()}catch(c){c instanceof Error&&c.message==="no local storage data"||console.error(c)}},[d]),r.isFetching||r.isLoading||!r.data||!d.rehydrated)return n.jsx(k,{});const o=r.data,y=et(o.dataSchema),x=c=>{e(!0),window.scrollTo(0,0),c.forEach(p=>{var l;if(p.property.includes("phone")){let u=0,m=p.property.match(/.campers\[(\d+)\]/);if(m&&m[1]!==void 0)u=m[1];else return;let v=`root_campers_${u}`;if(m=p.property.match(/\.([^.]+)$/),m&&m[1]!==void 0)v=`root_campers_${u}_${m[1]}`;else return;(l=document.getElementById(v))==null||l.focus()}})},h=({formData:c,...p})=>{i(b(!0)),i(L(c)),i(_(z(o,c))),i(b(!1)),d.saveFormData(c)},F=async()=>{const{invitation:c}=o;try{const p={formData:a.registration,pricingResults:a.totals,...!!c&&{invitation:c}},l=await s(p);if(W("submitRegistration result",l),"error"in l)throw new Error(`error fetching data: ${JSON.stringify(l)}`);const{data:u}=l;await i(J(u)),g("/payment")}catch(p){console.error("submissionError",p)}};return console.log("JsonSchemaForm registrationApi.data",o),n.jsx(M,{children:n.jsxs(B,{section:"RegistrationStep",children:[n.jsx(I,{schema:o.dataSchema,uiSchema:o.uiSchema,onChange:h,onSubmit:F,onError:x,formData:a.registration,transformErrors:y,templateData:{...o.templateVars||{},pricing:o.pricing,formData:a.registration,totals:a.totals},noHtml5Validate:!0,liveValidate:t,children:n.jsxs("div",{children:[!!o.event.epayment_handling&&n.jsxs(n.Fragment,{children:[n.jsx("h5",{children:"Handling charge"}),n.jsxs("div",{className:"md-template",children:["There is a handling charge of ",n.jsx("strong",{children:j(a.totals.handling)})," (",o.event.epayment_handling,"% of the total), however, we offer a ",o.event.epayment_handling,"% discount if you pay by check."]}),n.jsx("hr",{})]}),n.jsx(V,{markdown:o.preSubmitTemplate}),n.jsx("button",{type:"submit",className:"btn btn-info",children:"Continue to payment"})]})}),n.jsx(at,{})]})})}export{it as default};
